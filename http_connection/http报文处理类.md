# 关于http报文处理类

1. 主要功能

   http报文处理类是一个业务类，主要负责的功能为：

   - 接收http报文，并将该报文进行储存在缓存中
   - 解析http报文，根据报文内容进行业务处理，然后根据处理情况生成相应的回复报文
   - 发送报文给客户端，支持大文件的传输

2. 设计思路

   - 接收报文这一模块没什么好说的，就是根据ET和LT触发模式的不同，选择不同的接收方式来将报文存储到缓存中。

   - 解析报文这个模块是这个类的核心模块，我这里主要是通过有限状态机来实现报文解析的，下面讲讲我为什么使用状态机：

     - 使用状态机最主要的原因是：tcp是一个面向字节流的协议，我们无法保证每次解析报文时都获得了完整的报文（特别是使用LT的触发模式时），所以对于一个http报文的内容往往要通过多次解析。这样我们就需要记录当前的解析状态，还要在解析过程中不停的变换解析状态。在这种情况下，使用有限状态机就是最好的方式了。

     - 状态机的具体实现：在解析报文时，同时有两个状态机进行工作。

       - 一个是从状态机，负责从http报文中读取一行内容（http协议中以“\r\n”作为一行的结尾），其主要有三种状态：完整读取了一行、报文语法有误、读取的行不完整。
       - 一个是主状态机，标识当前读取的状态，主要包括三种状态：解析请求头、解析请求行、解析请求体。

       具体解析时，由主状态机调用从状态机解析行，从状态机解析完一行后驱动主状态机进行状态变更。主状态机和从状态机都会维护自己的状态，这样每次通过这些状态就能进入正确的解析流程

     - 使用有限状态机来解决问题也会产生一个问题：对于每个http请求我们都需要储存它的状态，但是http请求是无状态的，这就要求我们需要确保每个http请求在同一个线程中完成。这里可以采用的方法是：使用epoll的参数`EPOLLONESHOT`，该参数可以保证在一个线程解析http报文过程中，其他的线程无法并发的解析该报文。

   - 发送端的主体思路与接收报文相似。当这里我为了能够传输大文件，使用了mmap共享内存，这样即使发送报文的响应正文很长也不会出现错误。

3. 存在问题

   ​		事实上，编写这个类的过程十分痛苦，主要原因是在设计初期没有很好的设计整个类的架构，最后写出来的代码也十分冗杂。而且，作为一个业务类，这个类功能应该是需要经常变更的，但目前的代码结构对于变更十分不友好，往往添加一个功能得深入处理函数的内部进行修改。不得不承认，这个类是目前项目中最不优雅的一个类，现在想来，应该在设计初期考虑运用一些设计模式来优化代码结构：比如说状态机这一块，包含这么多enum类型的状态，这里就可以使用状态模式来进行结构优化。
