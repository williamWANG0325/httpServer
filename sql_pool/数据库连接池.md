# 关于数据库连接池

1. 设计思路

   数据库连接池是本项目第二个池式组件，目的在于减少频繁创建和销毁数据库连接带来的开销。主要内容如下：

   - 设计`SQLconnection`类，其中封装了数据库连接与该连接的存在时间，同时封装了连接与数据库交互的函数。
   - 为确保数据库连接池的唯一性，这里也使用单例模式编写连接池。
   - 内部逻辑同样采用生产者消费者模型，但这次的模型又与线程池有所不同。线程池本身是作为消费者，由外界向线程池提供任务；而数据库连接池是是作为生产者向外部提供数据库连接。
   - 连接池内部设有检查线程，负责清理超时的连接，可以实现自适应的增长和减少线程数量。

2. 具体细节

   一、这个组件中，第一个值得记录的点就在于RALL机制的实现：

   - 首先，我认为凡是向外界提供一个指针或是一个变量实体，那么为这个指针实现RALL机制就是十分必要的。这样可以减少该组件使用者的负担。
   - 就拿数据库连接池举例，连接池的原理是：从自己的连接队列中取出连接交给调用者；调用者使用完后将连接返回连接队列。这里如果不使用RALL机制，那么就要求调用者在使用后调用某个函数来归还连接。这样的话，显然会增加调用者的负担，而且如果调用者忘记调用函数，那么该连接就无法再被使用了。更重要的是，在多线程的环境下，这个归还的时间有时是难以确定的，这时RALL机制的优越性就展现出来了。
   - 实现RALL的方法有很多，我看到大多数实现的办法是再包装一个RALL的类，通过该类获取连接，而该类的析构函数中就是归还连接。
   - 但我这里使用的是智能指针，我认为这是更好的办法。可以通过定制智能指针的析构来实现连接的归还，这样可以少写一个类，简洁优雅，还能享受智能指针的一些优点，比如引用计数。

   二、第二个值得记录的点是关于连接数量自动管理的实现

   - 其实在线程池的时候就想着要加数量自动管理，所以在数据库连接池这里实现了
   - 自动增加的实现就是直接在连接数不够的时候生产新的连接
   - 而自动销毁的实现稍微复杂些。自动销毁需要开一个子线程定期查看连接队列中连接的情况，发现超时的连接就清理该连接。这里定时查看的功能我是通过条件变量实现的，条件变量的`wait_for`函数在这种情况下充当定时器的功能。不得不说条件变量的功能还是非常强大的，本项目中大量的使用条件变量。
